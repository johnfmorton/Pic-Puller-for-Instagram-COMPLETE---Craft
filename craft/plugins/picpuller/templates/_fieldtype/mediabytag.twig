{# http://craft.pp.dev/admin/picpuller/mediabytag/{{ searchTag }}/{{ nextMaxId }} #}
{% header "Content-Type: application/json" %}

{% set shareoauth = craft.picpuller.getShareOauthSetting %}

{% if shareoauth == false %}
    {% set pp_user = currentUser.id %}
{% else %}
    {% set pp_user = craft.picpuller.getSharedOauthUser %}
{% endif %}


{% if searchTag is not defined %}
{# TO DO:  #}
{# There was an error - return error message here #}
{% endif %}
{% set searchTag = craft.request.getSegment(3) %}
{% set nextmaxid = craft.request.getSegment(4) %}
{#

{{ currentUser.id }}
{{ nextmaxid }}
{{ searchTag }}

 #}
{% for instagramdata in craft.picpuller.tagged_media({'user_id' : pp_user, 'tag' :  searchTag , 'use_stale_cache' : true, 'limit': 30, 'max_id': nextmaxid }) %}
{% if instagramdata.status is defined and instagramdata.status == 'true' %}
{% if loop.first %}
{
    "meta": {"nextMaxId" : "{{instagramdata.next_max_id}}"},
    "ppimages": [
            {% endif %}{% if instagramdata.status == 'true' %} {
                "url": "{{instagramdata.low_resolution}}",
                "video" : {% if instagramdata.video_low_resolution != '' %}1{% else %}0{% endif %},
                "media_id": "{{ instagramdata.media_id }}"
}{% if loop.last == false %},
        {% endif %}
    {% endif %}
{% if loop.last %}
    ]
}{% endif %}
{% endif %}
{% endfor %}

