!function($){$.fn.imagebrowser=function(){function e(){if(""!==o.val()){var e=o.val();7===e.indexOf("instagr")?d(l(e)):n(e)}}function i(){v.slideUp().html("")}function a(e){var i=$(e.$container[0]),a=i.find(".pp-search .btn");i.on("click",".btn",function(e){$(e.target).hasClass("cancel")&&r.hide(),$(e.target).hasClass("igpic_next")&&($(e.target).hasClass("type-media")?($(e.target).removeClass("btn").removeClass("igpic_next").addClass("next_loading"),t($(e.target).data("nextmaxid"))):$(e.target).hasClass("type-search")&&($(e.target).removeClass("btn").removeClass("igpic_next").addClass("next_loading"),s(PicPuller.searchTag,$(e.target).data("nextmaxid"))))}),i.on("click",".selectable",function(e){var i=$(e.currentTarget).data("mediaid");o.val(i),n(i),r.hide()}),i.on("click",".pp-search .btn",function(){if(!a.hasClass("disabled")){PicPuller.searchTag=$(this).prev().val();var e=$("#pp-thumbs .main .elements");e.empty(),s(PicPuller.searchTag)}}),i.find(".pp-search input").keyup(function(){""!==$(this).val()?a.removeClass("disabled"):a.addClass("disabled")})}function t(e){var i=void 0===e?"":e,a="/"+PicPuller.adminPath+"/picpuller/mediarecent/"+i;$.ajax({url:a,dataType:"json",success:function(e){$(".igpic_next").remove(),$(".type-media").remove(),$(".next_loading").remove();var i=$("#pp-thumbs .main .elements"),a='<div class="igpic igpic_end">END</div>';""!==e.meta.nextMaxId&&(a='<div class=" igpic igpic_next type-media btn" data-nextmaxid="'+e.meta.nextMaxId+'"></div>');for(var t=0;t<e.ppimages.length;t++){var n=e.ppimages[t].video?"video":"photo",s='<div class="igpic selectable" data-mediaid="'+e.ppimages[t].media_id+'" style="background-image: url('+e.ppimages[t].url+'); background-size:cover;background-position: center;"><div class="'+n+'"></div></div>';i.append(s)}i.append(a)}})}function n(e){var i="/"+PicPuller.adminPath+"/picpuller/mediabyid/"+e;$.ajax({url:i,dataType:"json",success:function(e){var i="<div><div class='igpic_image' style='background-image: url("+e.ppimages[0].url+"); background-size:cover;background-position: center;'></div><div class='igpic_info'><p class='titlefield'>Preview from Instagram</p><p class='caption'><a href='"+e.ppimages[0].link+"' target='_blank' title='Open image link in new window'>"+e.ppimages[0].caption+"</a></p><p class='igpic_author'>By <strong>"+e.ppimages[0].full_name+"</strong> @"+e.ppimages[0].username+"</p></div></div>";v.html(i),v.slideDown()},error:function(){}})}function s(e,i){var a=void 0===i?"":i,t=encodeURIComponent(l(e)),n="/"+PicPuller.adminPath+"/picpuller/mediabytag/"+t+"/"+a;$.ajax({url:n,dataType:"json",success:function(e){$(".igpic_next").remove(),$(".type-search").remove(),$(".next_loading").remove();var i=$("#pp-thumbs .main .elements"),a='<div class="igpic igpic_end">END</div>';""!==e.meta.nextMaxId&&(a='<div class=" igpic igpic_next type-search btn" data-nextmaxid="'+e.meta.nextMaxId+'"></div>');for(var t=0;t<e.ppimages.length;t++){var n=e.ppimages[t].video?"video":"photo",s='<div class="igpic selectable" data-mediaid="'+e.ppimages[t].media_id+'"><div class="'+n+'"></div><img src="'+e.ppimages[t].url+'" alt="" width="100" height="100" border="0" /> </div>';i.append(s)}i.append(a)}})}function d(e){var i=null;$.ajax({url:"http://api.instagram.com/oembed?url="+e,contentType:"text/plain",xhrFields:{withCredentials:!1},dataType:"jsonp",success:function(e){return e.media_id?(i=e.media_id,o.val(i),n(i),void 0):null}})}function l(e){e=e.replace(/^\s+/,"");for(var i=e.length-1;i>=0;i--)if(/\S/.test(e.charAt(i))){e=e.substring(0,i+1);break}return e}function c(){var e=o.val();return""!==e?(m.removeClass("hidden"),!0):(m.addClass("hidden"),!1)}var r,p=$(this.selector+"-field .btn"),o=$("#"+PicPuller.fieldId+" input"),v=$("#"+PicPuller.fieldId+" .igpp.preview"),m=$("#"+PicPuller.fieldId+" .igpp.lookup"),u=$("#"+PicPuller.fieldId+" .igpp.delete");return e(),p.on("click",function(){var e=p.data("ppbrowsertype"),i='<div class="modal elementselectormodal" id="pp-thumbs"><div class="body"><div class="content" ><div class="main"><div class="toolbar"><h3>Instagram Images</h3>',n='<div class="pp-search"><input type="text" placeholder="one tag only"/> <div class="btn disabled submit small">Search</div></div>';0===e&&(n="");var s='</div><div class="elements"></div></div></div></div><div class="footer"><div class="buttons rightalign"><div class="btn cancel" tabindex=0>Cancel</div></div></div></div>',d=$(i+n+s);r?r.show():(r=new Garnish.Modal(d,{resizable:!0}),a(r),1!==e&&t())}),m.on("click",e),u.on("click",function(){o.val(""),i()}),o.keyup(function(){c(),i()}),this}}(jQuery);